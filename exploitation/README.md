# CVE-2024-29868 exploitation

### Attack Infographic

![attack-infographic](/exploitation/img/Streampipes_attack_infographic.png)

### Steps to reproduce the vulnerability

1.  Once the application is up and running. log in to Apache Streampipes (username: `admin@streampipes.apache.org`, password `admin`) and make sure that the "Allow self-registration" and "Allow self-service password recovery" options are checked.
    ![necessary-configuration](/exploitation/img/01-Necessary_configuration.png)

2.  Select the option to create a new account.
    ![create-new-account](/exploitation/img/02-Create_new_account.png)

3.  Register with an e-mail that is caught by MailHog (must end with `.local`)
    ![register-new-user](/exploitation/img/03-Register_new_user.png)

4.  Go back to the login page and select the "Forgot password" option.
    ![user-forgot-password-functionality](/exploitation/img/04-Use_the_forgot_password_functionality.png)

5.  Ask a password recovery token for the newly registered user.
    ![require-password-reset-token](/exploitation/img/05-Require_reset_token_for_attacker_account.png)

6.  Go to MailHog and take note of the path the application accepts to set a new password for a user and the token received.
    ![attacker-reset-token](/exploitation/img/06-Attacker_requested_password_reset_token.png)

7.  Compile `crack.c` (Code developed by [Alejo Popovici](https://github.com/alex91ar/randomstringutils/tree/master).) that you can find in this directory with the following command (you could get some warnings but it compiles correctly):

```bash
gcc -o cracker crack.c -lpthred -03 -m64
```

-   **-lpthread**: Links the pthread library, which is necessary for multithreading support.
-   **-O3**: Enables the highest level of optimization, which can improve the performance of the program.
-   **-m64**: Is used to generate code for a 64-bit environment.

8. Use the output binary to crack the token previously received in the attacker mail inbox.
   ![crack-the-token](/exploitation/img/08-Cracked_token.png)

9. Ask a password reset token for the administrator account (you need to change the admin e-mail so that it can be caught by MailHog).
   ![ask-password-reset-for-admin-account](/exploitation/img/09-Ask_password_reset_token_for_admin_account.png)

10. Take note of the password reset token received in the admin e-mail inbox.
    ![token-received-by-admin](/exploitation/img/10-Token_received_by_the_admin_e-mail_account.png)

11. Confront the token received by the admin and confirm that it's present between the previously cracked ones.
    ![predicted-tokens](/exploitation/img/11-Token_predicted.png)

12. Use the cracked token as value of the parameter "recoveryCode" of the url to set a new password for the admin account.
    ![set-new-password-for-admin](/exploitation/img/12-Using_the_recovered_token_the_attacker_can_set_a_new_password_for_the_admin_account.png)
    You have now effectively took over the admin account of the Apache StreamPipes instance.
